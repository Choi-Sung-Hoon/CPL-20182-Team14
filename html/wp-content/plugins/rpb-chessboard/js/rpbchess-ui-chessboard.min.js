!function(kokopu,$){"use strict";var SQUARE_MARKER_TOKEN=/^\s*([GRY])([a-h][1-8])\s*$/,ARROW_MARKER_TOKEN=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,SQUARE_MARKER_TOKEN_NO_COLOR=/^\s*[GRY]?([a-h][1-8])\s*$/,ARROW_MARKER_TOKEN_NO_COLOR=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;function parseMarkerList(value,re){for(var res={},tokens=value.split(","),k=0;k<tokens.length;++k)re.test(tokens[k])&&(res[RegExp.$2]=RegExp.$1);return res}function flattenMarkerList(markers){var res=[];for(var item in markers)markers.hasOwnProperty(item)&&res.push(markers[item]+item);return res.join(",")}function filterBoolean(value,defaultValue){return"boolean"==typeof value?value:"number"==typeof value?Boolean(value):"string"==typeof value?"true"===(value=value.toLowerCase())||"1"===value||"on"===value||"false"!==value&&"0"!==value&&"off"!==value&&defaultValue:defaultValue}function filterOptionSquareSize(squareSize){return Math.min(Math.max(squareSize,12),64)}function filterSetCode(code){return"string"==typeof code&&(code=code.toLowerCase(),/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(code))?code:""}function filterOptionInteractionMode(interactionMode){return"play"===interactionMode||"movePieces"===interactionMode||/^addPieces-[wb][kqrbnp]$/.test(interactionMode)||/^add(?:Square|Arrow)Markers-[GRY]$/.test(interactionMode)?interactionMode:"none"}function filterOptionAnimationSpeed(animationSpeed){return Math.max(0,animationSpeed)}function initializePosition(widget,fen){fen=fen.replace(/^\s+|\s+$/g,"");try{widget._position=/^(\w+):(.*)$/.test(fen)?new kokopu.Position(RegExp.$1,RegExp.$2):new kokopu.Position(fen),fen=widget._position.fen()}catch(e){if(!(e instanceof kokopu.exception.InvalidFEN))throw widget._position=null,e;widget._position=e}return fen}function initializeSquareMarkers(widget,value){return widget._squareMarkers=parseMarkerList(value,SQUARE_MARKER_TOKEN),flattenMarkerList(widget._squareMarkers)}function initializeArrowMarkers(widget,value){return widget._arrowMarkers=parseMarkerList(value,ARROW_MARKER_TOKEN),flattenMarkerList(widget._arrowMarkers)}function buildArrowMarkerStyle(color){var marker=document.createElementNS("http://www.w3.org/2000/svg","marker");marker.setAttribute("id","rpbui-chessboard-arrowMarkerEnd-"+color),marker.setAttribute("markerWidth",4),marker.setAttribute("markerHeight",4),marker.setAttribute("refX",2.5),marker.setAttribute("refY",2),marker.setAttribute("orient","auto");var path=document.createElementNS("http://www.w3.org/2000/svg","path");return path.setAttribute("d","M 4,2 L 0,4 L 1,2 L 0,0 Z"),marker.appendChild(path),marker}function buildArrow(identifierClazz,color,x1,y1,x2,y2){var line=document.createElementNS("http://www.w3.org/2000/svg","line");return line.setAttribute("class","rpbui-chessboard-arrowMarker "+identifierClazz+" rpbui-chessboard-markerColor-"+color),line.setAttribute("x1",x1),line.setAttribute("y1",y1),line.setAttribute("x2",x2),line.setAttribute("y2",y2),line.setAttribute("marker-end","url(#rpbui-chessboard-arrowMarkerEnd-"+color+")"),line}function buildColoredPiece(cp){var coloredPiece=document.createElement("div");return coloredPiece.className="rpbui-chessboard-sized rpbui-chessboard-piece rpbui-chessboard-piece-"+cp,coloredPiece.appendChild(buildHandle()),coloredPiece}function buildHandle(){var handle=document.createElement("div");return handle.className="rpbui-chessboard-handle",handle}function refresh(widget){if(function(widget){widget.element.empty()}(widget),null!==widget._position)if(widget._position instanceof kokopu.exception.InvalidFEN)widget.element.append(function(widget){var result=document.createElement("div");result.className="rpbui-chessboard-error";var title=document.createElement("div");if(title.className="rpbui-chessboard-errorTitle",title.appendChild(document.createTextNode("Error while analysing a FEN string.")),result.appendChild(title),null!==widget._position.message){var message=document.createElement("div");message.className="rpbui-chessboard-errorMessage",message.appendChild(document.createTextNode(widget._position.message)),result.appendChild(message)}return result}(widget));else if(widget.element.append(function(widget){var ROWS=widget.options.flip?"12345678":"87654321",COLUMNS=widget.options.flip?"hgfedcba":"abcdefgh",result=document.createElement("div"),globalClazz="rpbui-chessboard-table rpbui-chessboard-size"+widget.options.squareSize;widget.options.showCoordinates||(globalClazz+=" rpbui-chessboard-hideCoordinates"),""!==widget.options.colorset&&(globalClazz+=" rpbui-chessboard-colorset-"+widget.options.colorset),""!==widget.options.pieceset&&(globalClazz+=" rpbui-chessboard-pieceset-"+widget.options.pieceset),result.className=globalClazz;for(var r=0;r<8;++r){var row=document.createElement("div");row.className="rpbui-chessboard-row",result.appendChild(row);var rowHeader=document.createElement("div");rowHeader.className="rpbui-chessboard-cell rpbui-chessboard-rowCoordinate",rowHeader.appendChild(document.createTextNode(ROWS[r])),row.appendChild(rowHeader);for(var c=0;c<8;++c){var sq=COLUMNS[c]+ROWS[r],square=document.createElement("div"),clazz="rpbui-chessboard-sized rpbui-chessboard-cell rpbui-chessboard-square rpbui-chessboard-"+("w"===kokopu.squareColor(sq)?"light":"dark")+"Square";sq in widget._squareMarkers&&(clazz+=" rpbui-chessboard-squareMarker rpbui-chessboard-markerColor-"+widget._squareMarkers[sq]),square.className=clazz,row.appendChild(square);var cp=widget._position.square(sq);square.appendChild("-"===cp?buildHandle():buildColoredPiece(cp))}var flagCell=document.createElement("div");if(flagCell.className="rpbui-chessboard-cell","8"===ROWS[r]||"1"===ROWS[r]){var flag=document.createElement("div"),flagColor="8"===ROWS[r]?"b":"w";clazz="rpbui-chessboard-sized rpbui-chessboard-turnFlag rpbui-chessboard-color-"+flagColor,flagColor!==widget._position.turn()&&(clazz+=" rpbui-chessboard-inactiveFlag"),flag.className=clazz,flagCell.appendChild(flag)}row.appendChild(flagCell)}var columnHeaderRow=document.createElement("div");columnHeaderRow.className="rpbui-chessboard-row rpbui-chessboard-columnCoordinateRow";var firstColumnHeader=document.createElement("div");for(firstColumnHeader.className="rpbui-chessboard-cell rpbui-chessboard-rowCoordinate",columnHeaderRow.appendChild(firstColumnHeader),c=0;c<8;++c){var columnHeader=document.createElement("div");columnHeader.className="rpbui-chessboard-cell rpbui-chessboard-columnCoordinate",columnHeader.appendChild(document.createTextNode(COLUMNS[c])),columnHeaderRow.appendChild(columnHeader)}var lastColumnHeader=document.createElement("div");lastColumnHeader.className="rpbui-chessboard-cell",columnHeaderRow.appendChild(lastColumnHeader),result.appendChild(columnHeaderRow);var svg=document.createElementNS("http://www.w3.org/2000/svg","svg");svg.setAttribute("class","rpbui-chessboard-annotations"),svg.setAttribute("viewBox","0 0 8 8");var defs=document.createElementNS("http://www.w3.org/2000/svg","defs");for(var arrow in defs.appendChild(buildArrowMarkerStyle("G")),defs.appendChild(buildArrowMarkerStyle("R")),defs.appendChild(buildArrowMarkerStyle("Y")),defs.appendChild(buildArrowMarkerStyle("B")),svg.appendChild(defs),result.appendChild(svg),widget._arrowMarkers)if(widget._arrowMarkers.hasOwnProperty(arrow)&&/^([a-h][1-8])([a-h][1-8])$/.test(arrow)){var fromSquare=RegExp.$1,toSquare=RegExp.$2;if(fromSquare!==toSquare){var vc=getArrowCoordinatesInSVG(widget,fromSquare,toSquare),identifierClazz="rpbui-chessboard-arrowMarker-"+fromSquare+toSquare;svg.appendChild(buildArrow(identifierClazz,widget._arrowMarkers[arrow],vc.x1,vc.y1,vc.x2,vc.y2))}}null!==widget._moveArrow&&(vc=getArrowCoordinatesInSVG(widget,widget._moveArrow.from,widget._moveArrow.to),svg.appendChild(buildArrow("rpbui-chessboard-moveArrow","B",vc.x1,vc.y1,vc.x2,vc.y2)));return result}(widget)),"play"===widget.options.interactionMode||"movePieces"===widget.options.interactionMode)tagSquares(widget),function(widget,playMode){$(".rpbui-chessboard-piece",widget.element).draggable({cursor:"move",cursorAt:{top:widget.options.squareSize/2,left:widget.options.squareSize/2},revert:!0,revertDuration:0,zIndex:300});var tableNode=$(".rpbui-chessboard-table",widget.element).get(0);$(".rpbui-chessboard-square",widget.element).droppable({hoverClass:"rpbui-chessboard-squareHover",accept:function(e){return $(e).closest(".rpbui-chessboard-table").get(0)===tableNode},drop:function(event,ui){var target=$(event.target),movingPiece=ui.draggable;if(movingPiece.hasClass("rpbui-chessboard-piece"))if(playMode){var moveDescriptor=widget._position.isMoveLegal(movingPiece.parent().data("square"),target.data("square"));if(!moveDescriptor)return;switch(moveDescriptor.status){case"regular":moveDescriptor=moveDescriptor();break;case"promotion":moveDescriptor=moveDescriptor("q");break;case"castle960":moveDescriptor=moveDescriptor("castle");break;default:return}doPlay(widget,moveDescriptor,!1,widget.options.showMoveArrow)}else{var move={from:movingPiece.parent().data("square"),to:target.data("square")};doMovePiece(widget,move,!1,widget.options.showMoveArrow)}}})}(widget,"play"===widget.options.interactionMode);else if(/^addPieces-([wb][kqrbnp])$/.test(widget.options.interactionMode)){var coloredPiece=RegExp.$1;tagSquares(widget),function(widget,coloredPiece){$(".rpbui-chessboard-square",widget.element).mousedown(function(){!function(widget,coloredPiece,square,target){widget._position.square(square)===coloredPiece?(widget._position.square(square,"-"),target.empty().append(buildHandle())):(widget._position.square(square,coloredPiece),target.empty().append(buildColoredPiece(coloredPiece)));notifyFENChanged(widget)}(widget,coloredPiece,$(this).data("square"),$(this))})}(widget,coloredPiece)}else if(/^addSquareMarkers-([GRY])$/.test(widget.options.interactionMode)){var markerColor=RegExp.$1;tagSquares(widget),function(widget,markerColor){$(".rpbui-chessboard-square",widget.element).mousedown(function(){!function(widget,color,square,target){widget._squareMarkers[square]===color?(onSquareMarkerChanged(target,color),delete widget._squareMarkers[square]):(onSquareMarkerChanged(target,widget._squareMarkers[square],color),widget._squareMarkers[square]=color);notifySquareMarkersChanged(widget)}(widget,markerColor,$(this).data("square"),$(this))})}(widget,markerColor)}else if(/^addArrowMarkers-([GRY])$/.test(widget.options.interactionMode)){markerColor=RegExp.$1;tagSquares(widget),function(widget,markerColor){var fromSquare=null,canvasOffset=null,canvas=$(".rpbui-chessboard-annotations",widget.element),canvasWidth=canvas.width(),canvasHeight=canvas.height();$(".rpbui-chessboard-square .rpbui-chessboard-handle",widget.element).draggable({cursor:"crosshair",cursorAt:{top:widget.options.squareSize/2,left:widget.options.squareSize/2},helper:function(){return $('<div class="rpbui-chessboard-sized"></div>')},start:function(event){fromSquare=$(event.target).closest(".rpbui-chessboard-square").data("square"),canvasOffset=canvas.offset();var p=getSquareCoordinatesInSVG(widget,fromSquare);$(".rpbui-chessboard-annotations",widget.element).append(buildArrow("rpbui-chessboard-draggedArrow",markerColor,p.x,p.y,p.x,p.y))},drag:function(event){var y,x;$(".rpbui-chessboard-draggedArrow",widget.element).attr({x2:(x=event.pageX,8*(x-canvasOffset.left)/canvasWidth),y2:(y=event.pageY,8*(y-canvasOffset.top)/canvasHeight)})},stop:function(){$(".rpbui-chessboard-draggedArrow",widget.element).remove()}});var tableNode=$(".rpbui-chessboard-table",widget.element).get(0);$(".rpbui-chessboard-square",widget.element).droppable({hoverClass:"rpbui-chessboard-squareHover",accept:function(e){return $(e).closest(".rpbui-chessboard-table").get(0)===tableNode},drop:function(event){var toSquare=$(event.target).data("square");!function(widget,color,fromSquare,toSquare){var key=fromSquare+toSquare;widget._arrowMarkers[key]===color?(onArrowMarkerChanged(widget,key,widget._arrowMarkers[key]),delete widget._arrowMarkers[key]):(onArrowMarkerChanged(widget,key,widget._arrowMarkers[key],color),widget._arrowMarkers[key]=color);notifyArrowMarkersChanged(widget)}(widget,markerColor,fromSquare,toSquare)}})}(widget,markerColor)}}function onSquareMarkerChanged(target,oldValue,newValue){void 0===oldValue?target.addClass("rpbui-chessboard-squareMarker").addClass("rpbui-chessboard-markerColor-"+newValue):void 0===newValue?target.removeClass("rpbui-chessboard-squareMarker").removeClass("rpbui-chessboard-markerColor-"+oldValue):target.removeClass("rpbui-chessboard-markerColor-"+oldValue).addClass("rpbui-chessboard-markerColor-"+newValue)}function onArrowMarkerChanged(widget,key,oldValue,newValue){var identifierClazz="rpbui-chessboard-arrowMarker-"+key;if(void 0===oldValue){var fromSquare=key.substr(0,2),toSquare=key.substr(2,2);if(fromSquare!==toSquare){var vc=getArrowCoordinatesInSVG(widget,fromSquare,toSquare);$(".rpbui-chessboard-annotations",widget.element).append(buildArrow(identifierClazz,newValue,vc.x1,vc.y1,vc.x2,vc.y2))}}else if(void 0===newValue)$("."+identifierClazz,widget.element).remove();else{var clazz="rpbui-chessboard-arrowMarker "+identifierClazz+" rpbui-chessboard-markerColor-"+newValue,marker="url(#rpbui-chessboard-arrowMarkerEnd-"+newValue+")";$("."+identifierClazz,widget.element).attr("class",clazz).attr("marker-end",marker)}}function fetchSquare(widget,square){var ROWS=widget.options.flip?"12345678":"87654321",COLUMNS=widget.options.flip?"hgfedcba":"abcdefgh",r=ROWS.indexOf(square[1]),c=COLUMNS.indexOf(square[0]);return $($(".rpbui-chessboard-square",widget.element).get(8*r+c))}function getSquareCoordinatesInSVG(widget,square){var ROWS=widget.options.flip?"12345678":"87654321";return{x:(widget.options.flip?"hgfedcba":"abcdefgh").indexOf(square[0])+.5,y:ROWS.indexOf(square[1])+.5}}function getArrowCoordinatesInSVG(widget,fromSquare,toSquare){var p1=getSquareCoordinatesInSVG(widget,fromSquare),p2=getSquareCoordinatesInSVG(widget,toSquare);return p2.x+=p1.x<p2.x?-.3:p1.x>p2.x?.3:0,p2.y+=p1.y<p2.y?-.3:p1.y>p2.y?.3:0,{x1:p1.x,y1:p1.y,x2:p2.x,y2:p2.y}}function tagSquares(widget){var ROWS=widget.options.flip?"12345678":"87654321",COLUMNS=widget.options.flip?"hgfedcba":"abcdefgh",r=0,c=0;$(".rpbui-chessboard-square",widget.element).each(function(index,element){$(element).data("square",COLUMNS[c]+ROWS[r]),8===++c&&(c=0,++r)})}function doMovePiece(widget,move,animate,withArrow){move.from!==move.to&&"-"!==widget._position.square(move.from)&&(widget._position.square(move.to,widget._position.square(move.from)),widget._position.square(move.from,"-"),++widget._animationCounter,clearMoveArrow(widget),doDisplacement(widget,move.from,move.to,animate,withArrow),notifyFENChanged(widget))}function doPlay(widget,moveDescriptor,animate,withArrow){widget._position.play(moveDescriptor),++widget._animationCounter,clearMoveArrow(widget);var movingPiece=doDisplacement(widget,moveDescriptor.from(),moveDescriptor.to(),animate,withArrow);moveDescriptor.isCastling()&&doDisplacement(widget,moveDescriptor.rookFrom(),moveDescriptor.rookTo(),animate,!1),moveDescriptor.isEnPassant()&&fetchSquare(widget,moveDescriptor.enPassantSquare()).empty().append(buildHandle()),moveDescriptor.isPromotion()&&scheduleMoveAnimation(widget,animate,.8,function(){var oldClazz="rpbui-chessboard-piece-"+moveDescriptor.movingColoredPiece(),newClazz="rpbui-chessboard-piece-"+moveDescriptor.coloredPromotion();movingPiece.removeClass(oldClazz).addClass(newClazz)}),$(".rpbui-chessboard-turnFlag",widget.element).toggleClass("rpbui-chessboard-inactiveFlag"),notifyFENChanged(widget)}function clearMoveArrow(widget){widget._moveArrow=null,$(".rpbui-chessboard-moveArrow",widget.element).remove()}function doDisplacement(widget,from,to,animate,withArrow){var movingPiece=$(".rpbui-chessboard-piece",fetchSquare(widget,from));if(movingPiece.parent().append(buildHandle()),fetchSquare(widget,to).empty().append(movingPiece),withArrow&&from!==to){var vc=getArrowCoordinatesInSVG(widget,from,to);scheduleMoveAnimation(widget,animate,.5,function(){$(".rpbui-chessboard-annotations",widget.element).append(buildArrow("rpbui-chessboard-moveArrow","B",vc.x1,vc.y1,vc.x2,vc.y2))}),widget._moveArrow={from:from,to:to}}if(animate){var p1=kokopu.squareToCoordinates(from),p2=kokopu.squareToCoordinates(to),deltaTop=(p1.rank-p2.rank)*movingPiece.height()*(widget.options.flip?1:-1),deltaLeft=(p2.file-p1.file)*movingPiece.width()*(widget.options.flip?1:-1);movingPiece.css("top",deltaTop+"px"),movingPiece.css("left",deltaLeft+"px"),movingPiece.animate({top:"0px",left:"0px"},widget.options.animationSpeed)}return movingPiece}function scheduleMoveAnimation(widget,animate,delayFactor,callback){if(animate){var currentAnimationCounter=widget._animationCounter;setTimeout(function(){widget._animationCounter===currentAnimationCounter&&callback()},widget.options.animationSpeed*delayFactor)}else callback()}function notifyFENChanged(widget){var oldValue=widget.options.position;widget.options.position=widget._position.fen(),widget._trigger("positionChange",null,{oldValue:oldValue,newValue:widget.options.position})}function notifySquareMarkersChanged(widget){var oldValue=widget.options.squareMarkers;widget.options.squareMarkers=flattenMarkerList(widget._squareMarkers),widget._trigger("squareMarkersChange",null,{oldValue:oldValue,newValue:widget.options.squareMarkers})}function notifyArrowMarkersChanged(widget){var oldValue=widget.options.arrowMarkers;widget.options.arrowMarkers=flattenMarkerList(widget._arrowMarkers),widget._trigger("arrowMarkersChange",null,{oldValue:oldValue,newValue:widget.options.arrowMarkers})}$.chessboard={MINIMUM_SQUARE_SIZE:12,MAXIMUM_SQUARE_SIZE:64},$.widget("rpbchess-ui.chessboard",{options:{position:"empty",squareMarkers:"",arrowMarkers:"",flip:!1,squareSize:32,showCoordinates:!0,animationSpeed:200,showMoveArrow:!1,interactionMode:"none",colorset:"",pieceset:""},_position:null,_squareMarkers:null,_arrowMarkers:null,_moveArrow:null,_animationCounter:0,_create:function(){this.element.addClass("rpbui-chessboard").disableSelection(),this.options.position=initializePosition(this,this.options.position),this.options.squareMarkers=initializeSquareMarkers(this,this.options.squareMarkers),this.options.arrowMarkers=initializeArrowMarkers(this,this.options.arrowMarkers),this.options.squareSize=filterOptionSquareSize(this.options.squareSize),this.options.interactionMode=filterOptionInteractionMode(this.options.interactionMode),this.options.animationSpeed=filterOptionAnimationSpeed(this.options.animationSpeed),this.options.flip=filterBoolean(this.options.flip,!1),this.options.showCoordinates=filterBoolean(this.options.showCoordinates,!0),this.options.showMoveArrow=filterBoolean(this.options.showMoveArrow,!1),this.options.colorset=filterSetCode(this.options.colorset),this.options.pieceset=filterSetCode(this.options.pieceset),refresh(this)},_destroy:function(){this.element.empty().removeClass("rpbui-chessboard").enableSelection()},_setOption:function(key,value){switch(key){case"position":value=initializePosition(this,value);break;case"squareMarkers":value=initializeSquareMarkers(this,value);break;case"arrowMarkers":value=initializeArrowMarkers(this,value);break;case"squareSize":value=filterOptionSquareSize(value);break;case"interactionMode":value=filterOptionInteractionMode(value);break;case"animationSpeed":value=filterOptionAnimationSpeed(value);break;case"flip":value=filterBoolean(value,!1);break;case"showCoordinates":value=filterBoolean(value,!0);break;case"showMoveArrow":value=filterBoolean(value,!1);break;case"colorset":case"pieceset":value=filterSetCode(value)}var oldValue=this.options[key];if(oldValue!==value)switch(this.options[key]=value,key){case"position":this._moveArrow=null,refresh(this),this._trigger("positionChange",null,{oldValue:oldValue,newValue:this.options.position});break;case"flip":refresh(this),this._trigger("flipChange",null,{oldValue:oldValue,newValue:this.options.flip});break;case"squareMarkers":!function(widget){var oldSquareMarkers=$(".rpbui-chessboard-squareMarker",widget.element);for(var square in oldSquareMarkers.removeClass("rpbui-chessboard-markerColor-G"),oldSquareMarkers.removeClass("rpbui-chessboard-markerColor-R"),oldSquareMarkers.removeClass("rpbui-chessboard-markerColor-Y"),oldSquareMarkers.removeClass("rpbui-chessboard-squareMarker"),widget._squareMarkers)if(widget._squareMarkers.hasOwnProperty(square)){var color=widget._squareMarkers[square];fetchSquare(widget,square).addClass("rpbui-chessboard-squareMarker").addClass("rpbui-chessboard-markerColor-"+color)}}(this),this._trigger("squareMarkersChange",null,{oldValue:oldValue,newValue:this.options.squareMarkers});break;case"arrowMarkers":!function(widget){for(var key in $(".rpbui-chessboard-arrowMarker",widget.element).remove(),widget._arrowMarkers)if(widget._arrowMarkers.hasOwnProperty(key)){var fromSquare=key.substr(0,2),toSquare=key.substr(2,2);if(fromSquare!==toSquare){var vc=getArrowCoordinatesInSVG(widget,fromSquare,toSquare),arrow=buildArrow("rpbui-chessboard-arrowMarker-"+key,widget._arrowMarkers[key],vc.x1,vc.y1,vc.x2,vc.y2);$(".rpbui-chessboard-annotations",widget.element).append(arrow)}}}(this),this._trigger("arrowMarkersChange",null,{oldValue:oldValue,newValue:this.options.arrowMarkers});break;case"squareSize":!function(widget,oldValue,newValue){$(".rpbui-chessboard-table",widget.element).removeClass("rpbui-chessboard-size"+oldValue).addClass("rpbui-chessboard-size"+newValue)}(this,oldValue,value);break;case"showCoordinates":$(".rpbui-chessboard-table",this.element).toggleClass("rpbui-chessboard-hideCoordinates");break;case"animationSpeed":case"showMoveArrow":break;default:refresh(this)}},turn:function(value){if(null==value)return this._position.turn();value!==this._position.turn()&&(this._position.turn(value),$(".rpbui-chessboard-turnFlag",this.element).toggleClass("rpbui-chessboard-inactiveFlag"),notifyFENChanged(this))},castling:function(castle,value){if(null==value)return this._position.castling(castle);value!==this._position.castling(castle)&&(this._position.castling(castle,value),notifyFENChanged(this))},enPassant:function(value){if(null==value)return this._position.enPassant();value!==this._position.enPassant()&&(this._position.enPassant(value),notifyFENChanged(this))},movePiece:function(move){doMovePiece(this,move,0<this.options.animationSpeed,this.options.showMoveArrow)},play:function(move){doPlay(this,kokopu.isMoveDescriptor(move)?move:this._position.notation(move),0<this.options.animationSpeed,this.options.showMoveArrow)},addSquareMarker:function(squareMarker){if(SQUARE_MARKER_TOKEN.test(squareMarker)){var color=RegExp.$1,square=RegExp.$2;this._squareMarkers[square]!==color&&(onSquareMarkerChanged(fetchSquare(this,square),this._squareMarkers[square],color),this._squareMarkers[square]=color,notifySquareMarkersChanged(this))}},removeSquareMarker:function(squareMarker){if(SQUARE_MARKER_TOKEN_NO_COLOR.test(squareMarker)){var square=RegExp.$1;void 0!==this._squareMarkers[square]&&(onSquareMarkerChanged(fetchSquare(this,square),this._squareMarkers[square]),delete this._squareMarkers[square],notifySquareMarkersChanged(this))}},addArrowMarker:function(arrowMarker){if(ARROW_MARKER_TOKEN.test(arrowMarker)){var color=RegExp.$1,key=RegExp.$2;this._arrowMarkers[key]!==color&&(onArrowMarkerChanged(this,key,this._arrowMarkers[key],color),this._arrowMarkers[key]=color,notifyArrowMarkersChanged(this))}},removeArrowMarker:function(arrowMarker){if(ARROW_MARKER_TOKEN_NO_COLOR.test(arrowMarker)){var key=RegExp.$1;void 0!==this._arrowMarkers[key]&&(onArrowMarkerChanged(this,key,this._arrowMarkers[key]),delete this._arrowMarkers[key],notifyArrowMarkersChanged(this))}},sizeControlledByContainer:function(container,eventName){var obj=this;container.on(eventName,function(event,ui){void 0===obj._initialGeometryInfo&&(obj._initialGeometryInfo={squareSize:obj.options.squareSize,height:ui.originalSize.height,width:ui.originalSize.width});var deltaW=ui.size.width-obj._initialGeometryInfo.width,deltaH=ui.size.height-obj._initialGeometryInfo.height,deltaWPerSq=Math.floor(deltaW/9),deltaHPerSq=Math.floor(deltaH/8),newSquareSize=obj._initialGeometryInfo.squareSize+Math.min(deltaWPerSq,deltaHPerSq);obj._setOption("squareSize",newSquareSize)})}})}(kokopu,jQuery);