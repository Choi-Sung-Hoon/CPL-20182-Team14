!function(kokopu,$,moment,sanitizeHtml){"use strict";$.chessgame={navigationFrameOptions:{},navigationFrameClass:"",navigationButtonClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},GO_FIRST_MOVE_TOOLTIP:"Go to the beginning of the game",GO_PREVIOUS_MOVE_TOOLTIP:"Go to the previous move",GO_NEXT_MOVE_TOOLTIP:"Go to the next move",GO_LAST_MOVE_TOOLTIP:"Go to the end of the game",FLIP_TOOLTIP:"Flip the board",DOWNLOAD_PGN_TOOLTIP:"Download the game",PGN_DOWNLOAD_ERROR_MESSAGE:"Cannot download the PGN file.",PGN_PARSING_ERROR_MESSAGE:"Error while analysing a PGN string."}};var dynamicURL=null;var SPECIAL_NAGS_LOOKUP={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",11:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};function sanitizeRichText(text){return sanitizeHtml(text,{allowedTags:["a","b","br","code","em","i","span","strong","sub","sup"],allowedAttributes:{"*":["class","id","title"],a:["href","target"]}})}function capitalize(text){return 0===text.length?"":text.charAt(0).toUpperCase()+text.slice(1)}function filterBoolean(value,defaultValue){return"boolean"==typeof value?value:"number"==typeof value?Boolean(value):"string"==typeof value?"true"===(value=value.toLowerCase())||"1"===value||"on"===value||"false"!==value&&"0"!==value&&"off"!==value&&defaultValue:defaultValue}function filterNavigationBoard(value){switch(value){case"frame":case"floatLeft":case"floatRight":case"scrollLeft":case"scrollRight":case"above":case"below":return value;default:return"none"}}function filterChessboardOptions(value){var result={};return void 0!==value.flip&&(result.flip=value.flip),void 0!==value.squareSize&&(result.squareSize=value.squareSize),void 0!==value.showCoordinates&&(result.showCoordinates=value.showCoordinates),void 0!==value.colorset&&(result.colorset=value.colorset),void 0!==value.pieceset&&(result.pieceset=value.pieceset),void 0!==value.animationSpeed&&(result.animationSpeed=value.animationSpeed),void 0!==value.showMoveArrow&&(result.showMoveArrow=value.showMoveArrow),result}function initializeURL(widget,url){return"string"!=typeof url||""===url?"":(widget.options.pgn="",widget._game=null,$.get(url).done(function(data){widget.options.pgn=initializePGN(widget,data),refresh(widget)}).fail(function(){widget._game={title:$.chessgame.i18n.PGN_DOWNLOAD_ERROR_MESSAGE,message:url},refresh(widget)}),url)}function initializePGN(widget,pgn){"string"!=typeof pgn&&(pgn="*"),pgn=pgn.replace(/^\s+|\s+$/g,"");try{widget._game=kokopu.pgnRead(pgn,widget.options.gameIndex)}catch(error){if(!(error instanceof kokopu.exception.InvalidPGN))throw widget._game=null,error;widget._game=error}return pgn}function initializePieceSymbols(widget,pieceSymbols){var FIELDS=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(pieceSymbols)){pieceSymbols=pieceSymbols.toUpperCase(),widget._pieceSymbolTable={};for(var k=0;k<6;++k)widget._pieceSymbolTable[FIELDS[k]]=pieceSymbols.substr(k+1,1)}else switch(pieceSymbols){case"figurines":widget._pieceSymbolTable={};var font=function(font){switch(font){case"merida":case"pirat":return font;default:return"alpha"}}($.chessgame.chessFont);for(k=0;k<6;++k){var field=FIELDS[k];widget._pieceSymbolTable[field]='<span class="rpbui-chessgame-'+font+'Font">'+field+"</span>"}break;case"localized":widget._pieceSymbolTable={};for(k=0;k<6;++k){field=FIELDS[k];widget._pieceSymbolTable[field]=field in $.chessgame.i18n.PIECE_SYMBOLS?$.chessgame.i18n.PIECE_SYMBOLS[field]:field}break;default:widget._pieceSymbolTable={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},pieceSymbols="native"}return pieceSymbols}function stopScrollAreaSizeTimer(widget){null!==widget._scrollAreaSizeTimerId&&(clearInterval(widget._scrollAreaSizeTimerId),widget._scrollAreaSizeTimerId=null)}function destroyContent(widget){stopScrollAreaSizeTimer(widget),0!==$("#rpbui-chessgame-navigationFrameTarget",widget.element).length&&$("#rpbui-chessgame-navigationFrame").dialog("close"),widget.element.empty()}function refresh(widget){if(destroyContent(widget),null!==widget._game)if(widget._game instanceof kokopu.Game){var fragment=document.createDocumentFragment();fragment.appendChild(function(widget){var result=buildTextElement("div","rpbui-chessgame-move rpbui-chessgame-initialMove",$.chessgame.i18n.INITIAL_POSITION);return insertPositionInformation(result,widget._game.mainVariation(),!0),result}(widget)),fragment.appendChild(function(){var focusField=buildElement("a","rpbui-chessgame-focusField");focusField.setAttribute("href","#");var result=buildElement("div","rpbui-chessgame-focusFieldContainer");return result.appendChild(focusField),result}());var insertionPoint=fragment;switch(widget.options.navigationBoard){case"floatLeft":case"floatRight":case"above":fragment.appendChild(buildNavigationBox(widget));break;case"scrollLeft":case"scrollRight":insertionPoint=buildElement("div","rpbui-chessgame-scrollArea");var scrollBox=buildElement("div","rpbui-chessgame-scrollBox");scrollBox.appendChild("scrollLeft"===widget.options.navigationBoard?buildNavigationBox(widget):insertionPoint),scrollBox.appendChild("scrollLeft"===widget.options.navigationBoard?insertionPoint:buildNavigationBox(widget)),fragment.appendChild(scrollBox)}var headers=function(widget){var whitePlayer=buildPlayerNameHeader(widget,"w"),blackPlayer=buildPlayerNameHeader(widget,"b"),event=function(widget){var event=widget._game.event();if(void 0===event)return!1;var round=widget._game.round(),header=buildRichTextElement("div","rpbui-chessgame-event",event);void 0!==round&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-round",round));return header}(widget),datePlace=function(widget){var date=widget._game.date(),site=widget._game.site();if(void 0===date&&void 0===site)return!1;var header=buildElement("div","rpbui-chessgame-datePlaceGroup");void 0!==date&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-date",function(date){return date instanceof Date?capitalize(moment(date).format("LL")):"month"in date?capitalize(moment({year:date.year,month:date.month-1}).format("MMMM YYYY")):date.year}(date)));void 0!==site&&header.appendChild(buildRichTextElement("span","rpbui-chessgame-site",site));return header}(widget),annotator=function(widget){var annotator=widget._game.annotator();return void 0!==annotator&&buildRichTextElement("div","rpbui-chessgame-annotator",$.chessgame.i18n.ANNOTATED_BY.replace(/%1\$s/g,'<span class="rpbui-chessgame-annotatorName">'+annotator+"</span>"))}(widget);{if(whitePlayer||blackPlayer||event||datePlace||annotator){var result=buildElement("div","rpbui-chessgame-headers");return whitePlayer&&result.appendChild(whitePlayer),blackPlayer&&result.appendChild(blackPlayer),event&&result.appendChild(event),datePlace&&result.appendChild(datePlace),annotator&&result.appendChild(annotator),result}return!1}}(widget);headers&&insertionPoint.appendChild(headers);var body=function(widget){var mainVariation=function buildVariation(widget,variation,isMainVariation,gameResult){if(void 0===variation.comment()&&void 0===variation.first()&&"*"===gameResult)return!1;var variationClass="rpbui-chessgame-variation"+(isMainVariation?"":" rpbui-chessgame-subVariation");var result=buildElement(variation.isLongVariation()?"div":"span",variationClass);var enableMoveGroups=variation.isLongVariation();var moveGroupOpened=!1;var insertionPoint=result;function openMoveGroup(){enableMoveGroups&&!moveGroupOpened&&(insertionPoint=buildElement("div","rpbui-chessgame-moveGroup"),result.appendChild(insertionPoint),moveGroupOpened=!0)}function closeMoveGroup(){moveGroupOpened&&(insertionPoint=result,moveGroupOpened=!1)}void 0!==variation.comment()&&(variation.isLongComment()||openMoveGroup(),insertionPoint.appendChild(buildComment(variation,!0)));var forcePrintMoveNumber=!0;var node=variation.first();for(;void 0!==node;){openMoveGroup(),insertionPoint.appendChild(buildMove(widget,node,forcePrintMoveNumber)),void 0!==node.comment()&&(node.isLongComment()&&closeMoveGroup(),insertionPoint.appendChild(buildComment(node,!1)));for(var hasNonEmptySubVariations=!1,subVariations=node.variations(),k=0;k<subVariations.length;++k){var subVariationElement=buildVariation(widget,subVariations[k],!1,"*");subVariationElement&&(subVariations[k].isLongVariation()?closeMoveGroup():openMoveGroup(),insertionPoint.appendChild(subVariationElement),hasNonEmptySubVariations=!0)}forcePrintMoveNumber=void 0!==node.comment()||hasNonEmptySubVariations,node=node.next()}isMainVariation&&"*"!==gameResult&&(openMoveGroup(),insertionPoint.appendChild(buildTextElement("span","rpbui-chessgame-result",function(result){switch(result){case"1/2-1/2":return"½–½";case"1-0":return"1–0";case"0-1":return"0–1";default:return result}}(gameResult))));closeMoveGroup();return result}(widget,widget._game.mainVariation(),!0,widget._game.result());if(!mainVariation)return!1;var bodyClass="rpbui-chessgame-body";1<mainVariation.childNodes.length&&(bodyClass+=" rpbui-chessgame-moreSpace");"none"!==widget.options.navigationBoard&&(bodyClass+=" rpbui-chessgame-clickableMoves");var result=buildElement("div",bodyClass);return result.appendChild(mainVariation),result}(widget);switch(body&&insertionPoint.appendChild(body),widget.options.navigationBoard){case"floatLeft":case"floatRight":fragment.appendChild(buildElement("div","rpbui-chessgame-"+widget.options.navigationBoard.replace("float","clear")));break;case"below":fragment.appendChild(buildNavigationBox(widget))}if(widget.element.append(fragment),function(widget){$(".rpbui-chessgame-comment .rpbui-chessgame-diagramAnchor",widget.element).each(function(index,element){var anchor=$(element),commentNode=anchor.closest(".rpbui-chessgame-comment"),variant=widget._game.variant(),position=commentNode.data("position"),csl=commentNode.data("csl"),cal=commentNode.data("cal"),options={position:variant+":"+position};void 0!==csl&&(options.squareMarkers=csl),void 0!==cal&&(options.arrowMarkers=cal),$.extend(options,widget.options.diagramOptions),anchor.empty().removeClass("rpbui-chessgame-diagramAnchor").addClass("rpbui-chessgame-diagram").chessboard(options)})}(widget),"none"!==widget.options.navigationBoard&&(function(widget){$(".rpbui-chessgame-move",widget.element).click(function(){updateNavigationBoard(widget,$(this),!0),widget.focus()})}(widget),function(widget){$(".rpbui-chessgame-variation",widget.element).each(function(index,element){var variation=$(element),moves=variation.is("div")?variation.children(".rpbui-chessgame-moveGroup").children(".rpbui-chessgame-move"):variation.children(".rpbui-chessgame-move"),previousMove=null;moves.each(function(index,element){var move=$(element);null!==previousMove&&(move.data("prevMove",previousMove),previousMove.data("nextMove",move)),previousMove=move})});var initialMove=$(".rpbui-chessgame-initialMove",widget.element),allMoves=$(".rpbui-chessgame-variation .rpbui-chessgame-move",widget.element);if(0!==allMoves.length){var secondMove=allMoves.first();secondMove.data("prevMove",initialMove),initialMove.data("nextMove",secondMove)}}(widget),$(".rpbui-chessgame-focusField",widget.element).keydown(function(event){"Home"===event.key?widget.goFirstMove():"ArrowLeft"===event.key?widget.goPreviousMove():"ArrowRight"===event.key?widget.goNextMove():"End"===event.key&&widget.goLastMove()}),"frame"!==widget.options.navigationBoard&&function(widget){$(".rpbui-chessgame-navigationBoard",widget.element).chessboard(widget.options.navigationBoardOptions),initializeNavigationButtons(function(buttonClass){return $(buttonClass,widget.element)},function(methodName){widget[methodName](),widget.focus()}),updateNavigationBoard(widget,$(".rpbui-chessgame-initialMove",widget.element),!1)}(widget),"scrollLeft"===widget.options.navigationBoard||"scrollRight"===widget.options.navigationBoard)){var currentHeight=$(".rpbui-chessgame-navigationBox",widget.element).height();0<currentHeight?$(".rpbui-chessgame-scrollArea",widget.element).css("height",currentHeight):widget._scrollAreaSizeTimerId=setInterval(function(){var currentHeightTmp=$(".rpbui-chessgame-navigationBox",widget.element).height();0<currentHeightTmp&&($(".rpbui-chessgame-scrollArea",widget.element).css("height",currentHeightTmp),stopScrollAreaSizeTimer(widget))},100)}}else widget.element.append(function(widget){var result=buildElement("div","rpbui-chessgame-error");result.appendChild(buildTextElement("div","rpbui-chessgame-errorTitle",widget._game instanceof kokopu.exception.InvalidPGN?$.chessgame.i18n.PGN_PARSING_ERROR_MESSAGE:widget._game.title)),null!==widget._game.message&&result.appendChild(buildTextElement("div","rpbui-chessgame-errorMessage",widget._game.message));if(null!==widget._game.index&&0<=widget._game.index){var errorAt=buildElement("div","rpbui-chessgame-errorAt");widget._game.index>=widget._game.pgn.length?errorAt.appendChild(document.createTextNode("Occurred at the end of the string.")):(errorAt.appendChild(document.createTextNode("Occurred at position "+widget._game.index+":")),errorAt.appendChild(buildTextElement("div","rpbui-chessgame-errorAtCode",function(text,pos,backwardCharacters,forwardCharacters){var p1=pos-backwardCharacters,e1="...";p1<=0&&(p1=0,e1="");var p2=pos+1+forwardCharacters,e2="...";p2>=text.length&&(p2=text.length,e2="");var retVal=e1+text.substr(p1,p2-p1)+e2;return(retVal=retVal.replace(/\n|\t/g," "))+"\n"+new Array(1+e1.length+pos-p1).join(" ")+"^"}(widget._game.pgn,widget._game.index,10,40)))),result.appendChild(errorAt)}return result}(widget))}function buildPlayerNameHeader(widget,color){var name=widget._game.playerName(color);if(void 0===name)return!1;var header=buildElement("div","rpbui-chessgame-"+("w"===color?"white":"black")+"Player");header.appendChild(buildElement("span","rpbui-chessgame-colorTag")),header.appendChild(buildRichTextElement("span","rpbui-chessgame-playerName",name));var title=widget._game.playerTitle(color),rating=widget._game.playerElo(color);if(void 0!==title||void 0!==rating){var group=buildElement("span","rpbui-chessgame-titleRatingGroup");void 0!==title&&group.appendChild(buildRichTextElement("span","rpbui-chessgame-playerTitle",title)),void 0!==rating&&group.appendChild(buildRichTextElement("span","rpbui-chessgame-playerRating",rating)),header.appendChild(group)}return header}function insertPositionInformation(element,node,isVariation){element.setAttribute("data-position",(isVariation?node.initialPosition():node.position()).fen());var csl=node.tag("csl");void 0!==csl&&element.setAttribute("data-csl",csl);var cal=node.tag("cal");void 0!==cal&&element.setAttribute("data-cal",cal)}function buildComment(node,isVariation){var html=node.comment().replace(/\[#]/g,'<span class="rpbui-chessgame-diagramAnchor"></span>'),result=buildRichTextElement(node.isLongComment()?"div":"span","rpbui-chessgame-comment",html);return insertPositionInformation(result,node,isVariation),result}function buildMove(widget,node,forcePrintMoveNumber){var result=buildElement("span","rpbui-chessgame-move");insertPositionInformation(result,node,!1),result.setAttribute("data-position-before",node.positionBefore().fen()),result.setAttribute("data-move-notation",node.notation());var moveNumberClass="rpbui-chessgame-moveNumber"+(forcePrintMoveNumber||"w"===node.moveColor()?"":" rpbui-chessgame-hidden"),moveNumberText=node.fullMoveNumber()+("w"===node.moveColor()?".":"…");result.appendChild(buildTextElement("span",moveNumberClass,moveNumberText));for(var nag,pieceSymbolTable=widget._pieceSymbolTable,html=node.notation().replace(/[KQRBNP]/g,function(match){return pieceSymbolTable[match]}),nags=node.nags(),k=0;k<nags.length;++k)html+=" "+((nag=nags[k])in SPECIAL_NAGS_LOOKUP?SPECIAL_NAGS_LOOKUP[nag]:"$"+nag);return result.insertAdjacentHTML("beforeend",sanitizeRichText(html)),result}function buildNavigationBox(widget){var result=buildElement("div","rpbui-chessgame-navigationBox rpbui-chessgame-"+widget.options.navigationBoard);return insertNavigationSkeleton(result),result}function insertNavigationSkeleton(element){element.appendChild(buildElement("div","rpbui-chessgame-navigationBoard"));var buttonsClass="rpbui-chessgame-navigationButtons";""!==$.chessgame.navigationButtonClass&&(buttonsClass+=" "+$.chessgame.navigationButtonClass);var buttons=buildElement("div",buttonsClass);function addButton(buttonClass,buttonTitle){var button=buildElement("div",buttonClass);button.setAttribute("title",buttonTitle),buttons.appendChild(button)}element.appendChild(buttons),addButton("rpbui-chessgame-navigationButtonFirst",$.chessgame.i18n.GO_FIRST_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonPrevious",$.chessgame.i18n.GO_PREVIOUS_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonNext",$.chessgame.i18n.GO_NEXT_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonLast rpbui-chessgame-spaceAfter",$.chessgame.i18n.GO_LAST_MOVE_TOOLTIP),addButton("rpbui-chessgame-navigationButtonFlip rpbui-chessgame-spaceAfter",$.chessgame.i18n.FLIP_TOOLTIP),addButton("rpbui-chessgame-navigationButtonDownload rpbui-chessgame-spaceAfter",$.chessgame.i18n.DOWNLOAD_PGN_TOOLTIP);var downloadLink=buildElement("a","rpbui-chessgame-blobDownloadLink");downloadLink.setAttribute("href","#"),downloadLink.setAttribute("download","game.pgn"),element.appendChild(downloadLink)}function initializeNavigationButtons(selector,callback){selector(".rpbui-chessgame-navigationButtons").disableSelection(),selector(".rpbui-chessgame-navigationButtonFirst").button({icons:{primary:"ui-icon-seek-first"},text:!1}).click(function(){callback("goFirstMove")}),selector(".rpbui-chessgame-navigationButtonPrevious").button({icons:{primary:"ui-icon-seek-prev"},text:!1}).click(function(){callback("goPreviousMove")}),selector(".rpbui-chessgame-navigationButtonNext").button({icons:{primary:"ui-icon-seek-next"},text:!1}).click(function(){callback("goNextMove")}),selector(".rpbui-chessgame-navigationButtonLast").button({icons:{primary:"ui-icon-seek-end"},text:!1}).click(function(){callback("goLastMove")}),selector(".rpbui-chessgame-navigationButtonFlip").button({icons:{primary:"ui-icon-refresh"},text:!1}).click(function(){callback("flip")}),selector(".rpbui-chessgame-navigationButtonDownload").button({icons:{primary:"ui-icon-extlink"},text:!1}).click(function(){callback("downloadPGN")})}function buildTextElement(type,className,text){var result=buildElement(type,className);return result.appendChild(document.createTextNode(text)),result}function buildRichTextElement(type,className,html){var result=buildElement(type,className);return result.innerHTML=sanitizeRichText(html),result}function buildElement(type,className){var result=document.createElement(type);return""!==className&&(result.className=className),result}function updateNavigationBoard(widget,move,playTheMove){if(null!=move&&!move.hasClass("rpbui-chessgame-selectedMove")){if("frame"===widget.options.navigationBoard&&function(){if(0===$("#rpbui-chessgame-navigationFrame").length){var navigationFrame=buildElement("div","");navigationFrame.id="rpbui-chessgame-navigationFrame",insertNavigationSkeleton(navigationFrame),$("body").append(navigationFrame),$("#rpbui-chessgame-navigationFrame").dialog({create:function(event){$(event.target).parent().css("position","fixed")},resizeStart:function(event){$(event.target).parent().css("position","fixed")},resizeStop:function(event){$(event.target).parent().css("position","fixed")},autoOpen:!1,dialogClass:$.chessgame.navigationFrameClass,width:"auto",close:function(){unselectMove()}});var widget=$("#rpbui-chessgame-navigationFrame .rpbui-chessgame-navigationBoard");widget.chessboard(filterChessboardOptions($.chessgame.navigationFrameOptions)),widget.chessboard("sizeControlledByContainer",$("#rpbui-chessgame-navigationFrame"),"dialogresize"),initializeNavigationButtons(function(buttonClass){return $("#rpbui-chessgame-navigationFrame "+buttonClass)},function(methodName){var gameWidget=$("#rpbui-chessgame-navigationFrameTarget").closest(".rpbui-chessgame");gameWidget.chessgame(methodName),gameWidget.chessgame("focus")})}}(),updateNavigationBoardFlip(widget),function(widget){updateNavigationButton(widget,".rpbui-chessgame-navigationButtonFlip",widget.options.showFlipButton),updateNavigationButton(widget,".rpbui-chessgame-navigationButtonDownload",widget.options.showDownloadButton)}(widget),function(widget,move,playTheMove){var navigationBoard=retrieveNavigationBoard(widget);playTheMove?(navigationBoard.chessboard("option","position",widget._game.variant()+":"+move.data("positionBefore")),navigationBoard.chessboard("play",move.data("moveNotation"))):navigationBoard.chessboard("option","position",widget._game.variant()+":"+move.data("position"));var csl=move.data("csl"),cal=move.data("cal");navigationBoard.chessboard("option","squareMarkers",void 0===csl?"":csl),navigationBoard.chessboard("option","arrowMarkers",void 0===cal?"":cal)}(widget,move,playTheMove),function(widget,move){var global="frame"===widget.options.navigationBoard;unselectMove(global?null:$(".rpbui-chessgame-selectedMove",widget.element)),move.addClass("rpbui-chessgame-selectedMove"),global&&move.attr("id","rpbui-chessgame-navigationFrameTarget");var color=move.css("color");move.css("background-color",color),move.css("color",(colorString=color,.5<$.Color(colorString).lightness()?"black":"white"));var colorString}(widget,move),"frame"===widget.options.navigationBoard){var frame=$("#rpbui-chessgame-navigationFrame");frame.dialog("isOpen")||(frame.dialog("option","position",{my:"center",at:"center",of:window}),frame.dialog("open")),$(".ui-dialog-title",frame.closest(".ui-dialog")).empty().append(move.html())}var scrollTarget=$(".rpbui-chessgame-selectedMove",widget.element),allowScrollDown=!0;if(scrollTarget.hasClass("rpbui-chessgame-initialMove")&&(0===(scrollTarget=$(".rpbui-chessgame-headers",widget.element)).length&&(scrollTarget=$(".rpbui-chessgame-body",widget.element)),allowScrollDown=!1),"scrollLeft"===widget.options.navigationBoard||"scrollRight"===widget.options.navigationBoard){var scrollArea=$(".rpbui-chessgame-scrollArea",widget.element),targetOffsetTop=scrollTarget.offset().top-scrollArea.offset().top;targetOffsetTop<0?scrollArea.stop().animate({scrollTop:scrollArea.scrollTop()+targetOffsetTop},200):allowScrollDown&&targetOffsetTop+scrollTarget.height()>scrollArea.height()&&scrollArea.stop().animate({scrollTop:scrollArea.scrollTop()+targetOffsetTop+scrollTarget.height()-scrollArea.height()},200)}else if("frame"===widget.options.navigationBoard){var targetOffset=scrollTarget.offset();targetOffset.top<$(window).scrollTop()?$("html, body").stop().animate({scrollTop:targetOffset.top},200):allowScrollDown&&targetOffset.top+scrollTarget.height()>$(window).scrollTop()+window.innerHeight&&$("html, body").stop().animate({scrollTop:targetOffset.top+scrollTarget.height()-window.innerHeight},200)}}}function updateNavigationBoardFlip(widget){var navigationBoard=retrieveNavigationBoard(widget);widget.options.navigationBoardOptions.flip!==navigationBoard.chessboard("option","flip")&&navigationBoard.chessboard("option","flip",widget.options.navigationBoardOptions.flip)}function updateNavigationButton(widget,buttonClass,isVisible){var button="frame"===widget.options.navigationBoard?$("#rpbui-chessgame-navigationFrame "+buttonClass):$(buttonClass,widget.element);isVisible?button.show():button.hide()}function retrieveNavigationBoard(widget){return"frame"===widget.options.navigationBoard?$("#rpbui-chessgame-navigationFrame .rpbui-chessgame-navigationBoard"):$(".rpbui-chessgame-navigationBoard",widget.element)}function unselectMove(target){null==target&&(target=$("#rpbui-chessgame-navigationFrameTarget")),target.attr("style",null).attr("id",null).removeClass("rpbui-chessgame-selectedMove")}$.widget("rpbchess-ui.chessgame",{options:{pgn:"*",url:"",gameIndex:0,navigationBoard:"none",navigationBoardOptions:{},diagramOptions:{},pieceSymbols:"native",showFlipButton:!0,showDownloadButton:!0},_game:null,_pieceSymbolTable:null,_scrollAreaSizeTimerId:null,_create:function(){this.element.addClass("rpbui-chessgame"),this.options.url=initializeURL(this,this.options.url),this.options.url||(this.options.pgn=initializePGN(this,this.options.pgn)),this.options.pieceSymbols=initializePieceSymbols(this,this.options.pieceSymbols),this.options.navigationBoard=filterNavigationBoard(this.options.navigationBoard),this.options.navigationBoardOptions=filterChessboardOptions(this.options.navigationBoardOptions),this.options.diagramOptions=filterChessboardOptions(this.options.diagramOptions),this.options.showFlipButton=filterBoolean(this.options.showFlipButton,!0),this.options.showDownloadButton=filterBoolean(this.options.showDownloadButton,!0),refresh(this)},_destroy:function(){destroyContent(this),this.element.removeClass("rpbui-chessgame")},_setOption:function(key,value){switch(key){case"url":value=initializeURL(this,value);break;case"pgn":if(this.options.url)return;value=initializePGN(this,value);break;case"pieceSymbols":value=initializePieceSymbols(this,value);break;case"navigationBoard":value=filterNavigationBoard(value);break;case"navigationBoardOptions":case"diagramOptions":value=filterChessboardOptions(value);break;case"showFlipButton":case"showDownloadButton":value=filterBoolean(value,!0)}this.options[key]=value,refresh(this)},goFirstMove:function(){var target=$(".rpbui-chessgame-selectedMove",this.element);if(0!==target.length){for(;void 0!==target.data("prevMove");)target=target.data("prevMove");updateNavigationBoard(this,target,!1)}},goPreviousMove:function(){updateNavigationBoard(this,$(".rpbui-chessgame-selectedMove",this.element).data("prevMove"),!1)},goNextMove:function(){updateNavigationBoard(this,$(".rpbui-chessgame-selectedMove",this.element).data("nextMove"),!0)},goLastMove:function(){var target=$(".rpbui-chessgame-selectedMove",this.element);if(0!==target.length){for(;void 0!==target.data("nextMove");)target=target.data("nextMove");updateNavigationBoard(this,target,!1)}},flip:function(){this.options.navigationBoardOptions.flip=!this.options.navigationBoardOptions.flip,updateNavigationBoardFlip(this)},downloadPGN:function(){if(this.options.url)window.location.href=this.options.url;else{var data=new Blob([this.options.pgn],{type:"text/plain"});null!==dynamicURL&&window.URL.revokeObjectURL(dynamicURL),dynamicURL=window.URL.createObjectURL(data);var link="frame"===(widget=this).options.navigationBoard?$("#rpbui-chessgame-navigationFrame .rpbui-chessgame-blobDownloadLink"):$(".rpbui-chessgame-blobDownloadLink",widget.element);link.attr("href",dynamicURL),link.get(0).click()}var widget},focus:function(){$(".rpbui-chessgame-focusField",this.element).focus()}})}(kokopu,jQuery,moment,sanitizeHtml);